@{
    ViewBag.Title = "Usuarios";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<ol class="breadcrumb mb-4 mt-4">
    <li class="breadcrumb-item"><a href="index.html">Administrar</a></li>
    <li class="breadcrumb-item active">Usuarios</li>
</ol>

<div class="card">
    <div class="card-header">
        <i class="fas fa-user me-1"></i> Lista de Usuarios
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-12">
                <button type="button" class="btn btn-success" onclick="abrirModal(null)">Agregar</button>
            </div>
        </div>

        <hr />

        <table id="tabla" class="display cell-border" style="width:100%">
            <thead>
                <tr>
                    <th>Cédula</th>
                    <th>Nombre</th>
                    <th>Primer Apellido</th>
                    <th>Segundo Apellido</th>
                    <th>Rol</th>
                    <th>Correo</th>
                    <th>Activo</th>
                    <th>Fecha Creación</th>
                    <th>Acciones</th>
                </tr>
            </thead>
        </table>
    </div>
</div>

<div class="modal fade" id="FormModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="exampleModalLabel">Agregar Usuario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input id="UsuarioID" type="hidden" value="0" />

                <!-- Información Personal -->
                <div class="mb-3">
                    <label for="nombre" class="form-label">Nombre</label>
                    <input type="text" class="form-control" id="nombre">
                </div>
                <div class="mb-3">
                    <label for="apellido1" class="form-label">Primer Apellido</label>
                    <input type="text" class="form-control" id="apellido1">
                </div>
                <div class="mb-3">
                    <label for="apellido2" class="form-label">Segundo Apellido</label>
                    <input type="text" class="form-control" id="apellido2">
                </div>
                <div class="mb-3">
                    <label for="cedula" class="form-label">Cédula</label>
                    <input type="number" class="form-control" id="cedula">
                </div>
                <div class="mb-3">
                    <label for="correo" class="form-label">Correo</label>
                    <input type="email" class="form-control" id="correo">
                </div>
                <div class="mb-3">
                    <label for="tipoCorreoID" class="form-label">Tipo de Correo</label>
                    <select class="form-select" id="tipoCorreoID">
                        <option selected value="0">Seleccione un Tipo de Correo</option>
                        <!-- Tipos de correo dinámicamente poblados -->
                    </select>
                </div>
                <div class="mb-3">
                    <label for="rolID" class="form-label">Rol</label>
                    <select class="form-select" id="rolID">
                        <option selected value="0">Seleccione un Rol</option>
                        <!-- Roles dinámicamente poblados -->
                    </select>
                </div>
                <div id="mensajeError" class="alert alert-danger" role="alert" style="display:none;">
                    Todos los campos son obligatorios.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="Guardar()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<script>
    var tabladata;
    $(document).ready(function () {
        tabladata = $("#tabla").DataTable({
            responsive: true,
            "ajax": {
                url: '@Url.Action("ListarUsuarios", "Usuario")',
                type: "GET",
                datatype: "json"
            },
            "columns": [
                { "data": "Cedula" },
                { "data": "Nombre" },
                { "data": "Apellido1" },
                { "data": "Apellido2" },
                { "data": "Rol" },
                { "data": "Correo" },
                {
                    "data": "Activo",
                    "render": function (data) {
                        return data ? '<span class="badge bg-success">Sí</span>' : '<span class="badge bg-danger">No</span>';
                    }
                },
                {
                    "data": "FechaCreacion",
                    "render": function (data) {
                        return new Date(data).toISOString().split('T')[0];
                    }
                },
                {
                    "defaultContent": '<button class="btn btn-primary btn-editar">Editar</button> <button class="btn btn-danger btn-eliminar">Eliminar</button>',
                    "orderable": false
                }
            ],
            "language": {
                "url": "//cdn.datatables.net/plug-ins/1.10.20/i18n/Spanish.json"
            }
        });

        $('#tabla tbody').on('click', '.btn-editar', function () {
            var data = tabladata.row($(this).parents('tr')).data();
            abrirModal(data);
        });

        $('#tabla tbody').on('click', '.btn-eliminar', function () {
            var data = tabladata.row($(this).parents('tr')).data();
            if (confirm("¿Estás seguro de que deseas eliminar este usuario?")) {
                $.ajax({
                    url: '@Url.Action("EliminarUsuario", "Usuario")',
                    type: "POST",
                    data: { usuarioID: data.UsuarioID },
                    success: function (response) {
                        if (response.resultado) {
                            tabladata.ajax.reload();
                            alert("Usuario eliminado exitosamente");
                        } else {
                            alert("Error: " + response.mensaje);
                        }
                    }
                });
            }
        });
    });

    function abrirModal(data) {
        $("#UsuarioID").val(data ? data.UsuarioID : 0);
        $("#cedula").val(data ? data.Cedula : "");
        $("#nombre").val(data ? data.Nombre : "");
        $("#apellido1").val(data ? data.Apellido1 : "");
        $("#apellido2").val(data ? data.Apellido2 : "");
        $("#correo").val(data ? data.Correo : "");
        $("#rolID").val(data ? data.RolID : 0);
        $("#FormModal").modal("show");
    }

    function Guardar() {
        var usuario = {
            UsuarioID: parseInt($("#UsuarioID").val()),
            Cedula: parseInt($("#cedula").val()),
            Persona: {
                Cedula: parseInt($("#cedula").val()),
                Nombre: $("#nombre").val(),
                Apellido1: $("#apellido1").val(),
                Apellido2: $("#apellido2").val(),
                Correo: {
                    DireccionCorreo: $("#correo").val(),
                    TipoCorreoID: parseInt($("#tipoCorreoID").val())
                }
            },
            RolID: parseInt($("#rolID").val())
        };

        if (!usuario.Cedula || !usuario.Persona.Nombre || !usuario.Persona.Apellido1 || !usuario.Persona.Apellido2 || !usuario.Persona.Correo.DireccionCorreo || !usuario.RolID) {
            $("#mensajeError").show();
            return;
        } else {
            $("#mensajeError").hide();
        }

        $.ajax({
            url: '@Url.Action("GuardarUsuario", "Usuario")',
            type: "POST",
            data: JSON.stringify(usuario),
            contentType: "application/json; charset=utf-8",
            success: function (response) {
                if (response.resultado != 0) {
                    tabladata.ajax.reload();
                    $("#FormModal").modal("hide");
                } else {
                    alert("Error: " + response.mensaje);
                }
            }
        });
    }
</script>
